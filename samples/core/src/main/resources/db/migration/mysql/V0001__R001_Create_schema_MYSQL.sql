-- Rename this file to V0001__R001_Create_schema_MYSQL.sql.mysql if the database used is not MariaDB 10.0.27

-- This is the SQL script for setting up the DDL for the h2 database
-- In a typical project you would only distinguish between main and test for flyway SQLs
-- However, in this sample application we provde support for multiple databases in parallel
-- You can simply choose the DB of your choice by setting spring.profiles.active=XXX in config/application.properties
-- Assuming that the preconfigured user exists with according credentials using the included SQLs

USE ridesharing;

SET FOREIGN_KEY_CHECKS = 0;

-- *** Transportpoint **
CREATE TABLE TRANSPORTPOINT(
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY, 
    modificationCounter INT NOT NULL,  
    Name VARCHAR(255), 
    CGLocation bit,
    Country VARCHAR(255), 
    City VARCHAR(255),
    LocationAddress VARCHAR(255),
    GPSCoordination VARCHAR(255)
);

-- ** CGUser**
CREATE TABLE CGMEMBER(
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    modificationCounter INT NOT NULL,
    Name VARCHAR(255),
    password VARCHAR(10),
    EmailAddress VARCHAR(255),
    MobileNumber VARCHAR(20),
    CGHomeLocation VARCHAR(255),
    ValidationStatus bit,
    Role VARCHAR(255),
    CreationDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- *** RS Offer ***
CREATE TABLE RSOFFER(
    ID BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    modificationCounter INT NOT NULL,
    UserID BIGINT NOT NULL, 
    FromLocation BIGINT NOT NULL,
    ToLocation BIGINT NOT NULL, 
    DepartureTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    Delay INT, 
    NumberOfPlaces INT,
    LuggageSpace VARCHAR(10),
    Status bit,
    CreationDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ** RSOFFER dependency --
ALTER TABLE RSOFFER ADD CONSTRAINT FK_RSOFFER2CGUSERPROFILE FOREIGN KEY(UserID) REFERENCES CGMEMBER(id);
ALTER TABLE RSOFFER ADD CONSTRAINT FK_RSOFFER2TRANSPORTPOINTFROM FOREIGN KEY(FromLocation) REFERENCES TRANSPORTPOINT(id);
ALTER TABLE RSOFFER ADD CONSTRAINT FK_RSOFFER2TRANSPORTPOINTTO FOREIGN KEY(ToLocation) REFERENCES TRANSPORTPOINT(id);

-- *** RS Request ***
CREATE TABLE REQUEST(
    ID BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    modificationCounter INT NOT NULL,
    UserID BIGINT NOT NULL, 
    FromLocation BIGINT NOT NULL, 
    ToLocation BIGINT NOT NULL, 
    EarliestDepartureTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LatestDepartureTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    NumberOfPlaces INT,
    LuggageSpace VARCHAR(10),
    RSOFFERIDMapped BIGINT,
    CreationDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ** REQUEST dependency --
ALTER TABLE REQUEST ADD CONSTRAINT FK_REQUEST2CGUSERPROFILE FOREIGN KEY(UserID) REFERENCES CGMEMBER(id);
ALTER TABLE REQUEST ADD CONSTRAINT FK_REQUEST2TRANSPORTPOINTFROM FOREIGN KEY(FromLocation) REFERENCES TRANSPORTPOINT(id);
ALTER TABLE REQUEST ADD CONSTRAINT FK_REQUEST2TRANSPORTPOINTTO FOREIGN KEY(ToLocation) REFERENCES TRANSPORTPOINT(id);
--ALTER TABLE REQUEST ADD CONSTRAINT FK_REQUEST2RSOFFER FOREIGN KEY(RSOFFERIDMapped) REFERENCES RSOFFER(ID);

-- *** Staffmemeber ***

--ALTER TABLE STAFFMEMBER ADD CONSTRAINT UC_STAFFMEMBER_LOGIN UNIQUE(login);
-- *** Product ***


-- *** Offer ***


--ALTER TABLE OFFER ADD CONSTRAINT UC_OFFER_NAME UNIQUE(name);
--ALTER TABLE OFFER ADD CONSTRAINT UC_OFFER_NUMBER UNIQUE(number);

--ALTER TABLE OFFER ADD CONSTRAINT FK_OFFER2SIDEDISH FOREIGN KEY(sideDishId) REFERENCES PRODUCT(id);
--ALTER TABLE OFFER ADD CONSTRAINT FK_OFFER2MEAL FOREIGN KEY(mealId) REFERENCES PRODUCT(id);
--ALTER TABLE OFFER ADD CONSTRAINT FK_OFFER2DRINK FOREIGN KEY(drinkId) REFERENCES PRODUCT(id);

-- *** RestaurantTable (Table is a reserved keyword in Oracle) ***

--ALTER TABLE RESTAURANTTABLE ADD CONSTRAINT UC_TABLE_NUMBER UNIQUE(number);

-- *** RestaurantOrder (Order is a reserved keyword in Oracle) ***


-- *** OrderPosition ***

--ALTER TABLE ORDERPOSITION ADD CONSTRAINT FK_ORDPOS2ORDER FOREIGN KEY(orderId) REFERENCES RESTAURANTORDER(id);
--ALTER TABLE ORDERPOSITION ADD CONSTRAINT FK_ORDPOS2COOK FOREIGN KEY(cookId) REFERENCES STAFFMEMBER(id);

-- *** Bill ***

--ALTER TABLE BILLORDERPOSITION ADD CONSTRAINT FK_BILLORDPOS2BILL FOREIGN KEY(billId) REFERENCES BILL(id);
--ALTER TABLE BILLORDERPOSITION ADD CONSTRAINT FK_BILLORDPOS2ORDPOS FOREIGN KEY(orderPositionsId) REFERENCES ORDERPOSITION(id);

-- *** BinaryObject (BLOBs) ***


-- *** RevInfo (Commit log for envers audit trail) ***
CREATE TABLE REVINFO(
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    timestamp BIGINT NOT NULL,
    userLogin VARCHAR(255)
);

SET FOREIGN_KEY_CHECKS = 1;